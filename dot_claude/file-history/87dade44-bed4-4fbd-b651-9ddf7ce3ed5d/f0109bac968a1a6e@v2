# Workflow and Comparison Specification

## Detection → Annotation → Evaluation Workflow

Standard process for analyzing a track and creating ground truth annotations.

### Step 1: Run Detection

```bash
$ edm analyze track.flac --types structure --format yaml
```

Output: `track_detected_v2.yaml` (or `track_detected.yaml` after migration)

Contains:
- High-confidence sections/events (confidence >= 0.7)
- Experimental sections/events (0.5 <= confidence < 0.7, optional)
- All metadata (BPM, downbeat, time_signature)

### Step 2: Convert to Annotation Template

```bash
$ edm convert track_detected_v2.yaml --to-annotation > track_annotated.yaml
```

Generates:
- Annotation format (list-based, Option A)
- Sections copied from high-confidence output
- Drops copied from high-confidence events
- Confidence scores removed (implicit 1.0)
- Ready for human editing

Optional: View experimental detections
```bash
$ edm convert track_detected_v2.yaml --to-annotation --include-experimental
```

### Step 3: Human Review and Editing

Open `track_annotated.yaml` in editor and:
1. Verify section boundaries (adjust bar ranges as needed)
2. Correct mislabeled sections
3. Add missing sections
4. Remove false positive drops
5. Add missing drops

### Step 4: Compare Changes

Compare detected vs annotated:

```bash
$ edm diff track_detected_v2.yaml track_annotated.yaml
```

Output format:

```
SUMMARY
=======
Sections detected: 6
Sections annotated: 7
Drops detected: 3
Drops annotated: 2

SECTION ANALYSIS
================
High-Confidence Detected:
  intro (1-24): confidence 0.92 ✓ (matches annotation)
  verse (25-80): confidence 0.88 ✓ (matches annotation)
  breakdown (81-92): confidence 0.71 ✓ (matches annotation)

Missing from Annotation:
  buildup (93-104): confidence 0.78 (human skipped this)

Not in High-Confidence Detected:
  verse (105-126): Human annotated (detector missed)

Experimental Detections:
  breakdown (81-92): confidence 0.65 (exists in high-conf, skipped here)

DROP ANALYSIS
=============
Detected: bars 24, 88, 105
Annotated: bars 24, 105

False Positives (detected but not annotated):
  - bar 88: confidence 0.58 (correctly rejected as false positive)

Missing from Detections:
  (none - all annotated drops were detected)

CONFIDENCE SUMMARY
==================
High confidence (0.9+): 3 sections
Medium confidence (0.7-0.9): 3 sections
Low confidence (0.5-0.7): 1 section
```

### Step 5: Evaluate

Generate evaluation metrics:

```bash
$ edm evaluate structure --reference track_annotated.yaml
```

Output:
```
Evaluation Report: track_annotated.yaml
========================================

Precision, Recall, F-score (boundary detection):
  Section boundaries: 0.85 / 0.92 / 0.88

Label accuracy:
  intro: 100%
  verse: 89%
  breakdown: 75%
  buildup: 0% (missed)
  outro: 100%

Overall structure F-score: 0.87
```

## Diff Output Format

Detailed comparison showing what differs between detected and annotated:

```yaml
comparison:
  # Sections that appear in both with same boundaries
  exact_matches:
    - label: intro
      bars: 1-24
      detected_confidence: 0.92

  # Annotated but not detected
  missing_from_detection:
    - label: verse
      bars: 105-126
      reason: "New structure added by annotator"

  # Detected high-confidence but not in annotation
  not_in_annotation:
    - label: buildup
      bars: 93-104
      detected_confidence: 0.78
      reason: "Annotator skipped this section"

  # Different boundaries between detected and annotated
  boundary_changes:
    - label: breakdown
      detected: 81-92
      annotated: 81-94
      detected_confidence: 0.71
      change: "Extended by 2 bars"

  # Label changes without boundary change
  label_changes:
    - bars: 25-80
      detected_label: verse
      annotated_label: chorus
      detected_confidence: 0.88
      change: "Relabeled from verse to chorus"

  # Drop differences
  drops:
    exact_matches: [24, 105]

    false_positives:
      - bar: 88
        detected_confidence: 0.58
        annotated: false

    missing:
      # none
```

## Merging Consecutive Sections

When outputting, merge adjacent sections with identical labels:

**Before:**
```yaml
sections:
  - label: verse
    bars: 25-40
    confidence: 0.85

  - label: verse
    bars: 41-80
    confidence: 0.82
```

**After:**
```yaml
sections:
  - label: verse
    bars: 25-80
    confidence: 0.835  # Average of 0.85 and 0.82
```

Implementation:
```python
def merge_consecutive_sections(sections):
    """Merge adjacent sections with identical labels."""
    if not sections:
        return sections

    merged = [sections[0]]
    for section in sections[1:]:
        last = merged[-1]

        # Check if adjacent and same label
        if (section.start == last.end + 1 and
            section.label == last.label):
            # Merge: extend end, average confidence
            last.end = section.end
            last.confidence = (last.confidence + section.confidence) / 2
            last.bars = last.end - last.start + 1
        else:
            # Different label or gap: add as new section
            merged.append(section)

    return merged
```

## CLI Command Specification

### edm convert

Convert between detector and annotation formats:

```bash
# Detect → Annotation
$ edm convert input.yaml --to-annotation [--include-experimental] > output.yaml

# Annotation → Detect (for comparison)
$ edm convert input.yaml --to-detected > output.yaml

# Option A → Option B (if no repeated labels)
$ edm convert input.yaml --to-dict-format > output.yaml

# Option B → Option A
$ edm convert input.yaml --to-list-format > output.yaml
```

### edm diff

Compare two annotations or detected vs annotated:

```bash
# Compare detected vs annotated
$ edm diff detected.yaml annotated.yaml

# Compare two annotations (e.g., different annotators)
$ edm diff annotation_v1.yaml annotation_v2.yaml

# Quiet mode (only summary)
$ edm diff detected.yaml annotated.yaml --quiet

# Show experimental detections in diff
$ edm diff detected.yaml annotated.yaml --include-experimental
```

## Error Handling

### Invalid Annotations

Errors when reading annotation file:
- Missing required fields (file, bpm, structure)
- Invalid bar ranges (start > end, non-integers)
- Overlapping sections
- Gaps in coverage
- Drop bars outside valid range

Example error:
```
Error: Invalid annotation file
  - Gap in coverage: bars 24-24 not assigned (between verse and breakdown)
  - Section verse: bars should be "25-80" not "25-79"
```

### Conversion Errors

Errors when converting formats:
- Option B → A fails if labels repeat (show which labels)
- Cannot convert annotation to detected format (wrong direction)
- Experimental sections cannot be converted to Option B format

## Version History

- **v1.0**: Full workflow with comparison and CLI commands (this spec)
