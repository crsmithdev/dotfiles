#!/bin/bash
input=$(cat)

# Extract values from JSON input using grep/sed (no jq dependency)
extract() { echo "$input" | grep -o "\"$1\":[^,}]*" | sed 's/.*://; s/"//g; s/^ *//'; }

model=$(echo "$input" | grep -o '"display_name":"[^"]*"' | head -1 | sed 's/.*"display_name":"//; s/"$//')
cost=$(extract "total_cost_usd")
added=$(extract "total_lines_added")
removed=$(extract "total_lines_removed")
dur_ms=$(extract "total_duration_ms")
cwd=$(extract "cwd")

# Defaults
cost=${cost:-0}
added=${added:-0}
removed=${removed:-0}
dur_ms=${dur_ms:-0}

# Format duration
dur=$((dur_ms / 60000))m$(((dur_ms % 60000) / 1000))s

# Get git info
branch=$(git -C "$cwd" branch --show-current 2>/dev/null || echo "")
git_status=$(git -C "$cwd" status --porcelain 2>/dev/null | wc -l)

# Catppuccin Frappé colors
bg="#303446"
blue="#8caaee"
green="#a6d189"
red="#e78284"
peach="#ef9f76"
teal="#81c8be"
lavender="#ca9ee6"
subtext="#a5adce"
overlay="#414559"

# Helper to use 24-bit colors
color() {
    local hex="$1"
    local r=$((16#${hex:1:2}))
    local g=$((16#${hex:3:2}))
    local b=$((16#${hex:5:2}))
    echo -ne "\033[38;2;${r};${g};${b}m"
}

# Build status line
# Format: 󰚩 Model » cwd@branch [*N +A -R] (Xm $Y.YY)

output=""

# Model
output="$(color $blue)󰚩 ${model}\033[0m"

# Separator
output="$output $(color $subtext)»\033[0m "

# CWD
cwd_name=$(basename "$cwd")
output="$output$(color $subtext)${cwd_name}\033[0m"

# Branch (if in git repo)
if [ -n "$branch" ]; then
    output="$output$(color $subtext)@\033[0m$(color $lavender)${branch}\033[0m"
fi

# Git changes in brackets (only if there are changes)
git_changes=""
if [ "$git_status" -gt 0 ]; then
    git_changes="$(color $green)*${git_status}\033[0m"
fi
if [ "$added" != "0" ] || [ "$removed" != "0" ]; then
    if [ -n "$git_changes" ]; then
        git_changes="$git_changes "
    fi
    git_changes="$git_changes$(color $green)+${added}\033[0m $(color $red)-${removed}\033[0m"
fi
if [ -n "$git_changes" ]; then
    output="$output $(color $subtext)[\033[0m${git_changes}$(color $subtext)]\033[0m"
fi

# Session stats in parens
cost_fmt=$(printf "%.2f" "$cost")
output="$output $(color $subtext)(\033[0m$(color $teal)${dur}\033[0m $(color $peach)\$${cost_fmt}\033[0m$(color $subtext))\033[0m"

echo -e "$output"
