#!/bin/bash
input=$(cat)

# Extract values from JSON input using grep/sed (no jq dependency)
extract() { echo "$input" | grep -o "\"$1\":[^,}]*" | sed 's/.*://; s/"//g; s/^ *//'; }

model=$(echo "$input" | grep -o '"display_name":"[^"]*"' | head -1 | sed 's/.*"display_name":"//; s/"$//')
cost=$(extract "total_cost_usd")
added=$(extract "total_lines_added")
removed=$(extract "total_lines_removed")
dur_ms=$(extract "total_duration_ms")
cwd=$(extract "cwd")

# Defaults
cost=${cost:-0}
added=${added:-0}
removed=${removed:-0}
dur_ms=${dur_ms:-0}

# Format duration
dur=$((dur_ms / 60000))m$(((dur_ms % 60000) / 1000))s

# Get git info
branch=$(git -C "$cwd" branch --show-current 2>/dev/null || echo "")
git_status=$(git -C "$cwd" status --porcelain 2>/dev/null | wc -l)

# Catppuccin Frappé colors
bg="#303446"
blue="#8caaee"
green="#a6d189"
red="#e78284"
peach="#ef9f76"
teal="#81c8be"
lavender="#ca9ee6"
subtext="#a5adce"
overlay="#414559"

# Helper to use 24-bit colors
color() {
    local hex="$1"
    local r=$((16#${hex:1:2}))
    local g=$((16#${hex:3:2}))
    local b=$((16#${hex:5:2}))
    echo -ne "\033[38;2;${r};${g};${b}m"
}

# Build status line
status_parts=()

# Model (always show)
status_parts+=("$(color $blue)󰚩 ${model}\033[0m")

# Branch + git status (combined section)
if [ -n "$branch" ]; then
    branch_part="$(color $lavender)${branch}\033[0m"

    if [ "$git_status" -gt 0 ]; then
        branch_part="$branch_part $(color $green)*${git_status}\033[0m"
    fi

    status_parts+=("$branch_part")
fi

# Cost (2 decimal places)
cost_fmt=$(printf "%.2f" "$cost")
status_parts+=("$(color $peach)\$${cost_fmt}\033[0m")

# Lines changed (only if non-zero)
if [ "$added" != "0" ] || [ "$removed" != "0" ]; then
    status_parts+=("$(color $green)+${added}\033[0m $(color $red)-${removed}\033[0m")
fi

# Duration
status_parts+=("$(color $teal)${dur}\033[0m")

# Print with separators
(IFS=' │ '; echo -e "${status_parts[*]}")
