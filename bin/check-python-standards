#!/bin/bash
# Python Project Standards Validator
# Checks structural invariants and runs quality tools
# Usage: check-python-standards [project-dir]

set -e

PROJECT_DIR="${1:-.}"
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
EXAMPLES_DIR="$HOME/dotfiles/examples/python"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

PASSED=0
FAILED=0

# Helper functions
check_file() {
    local file=$1
    local description=$2
    if [ -f "$PROJECT_DIR/$file" ]; then
        echo -e "${GREEN}✓${NC} $description"
        ((PASSED++))
    else
        echo -e "${RED}✗${NC} $description (missing: $file)"
        ((FAILED++))
    fi
}

check_dir() {
    local dir=$1
    local description=$2
    if [ -d "$PROJECT_DIR/$dir" ]; then
        echo -e "${GREEN}✓${NC} $description"
        ((PASSED++))
    else
        echo -e "${RED}✗${NC} $description (missing: $dir)"
        ((FAILED++))
    fi
}

run_tool() {
    local tool=$1
    local cmd=$2
    local description=$3

    if command -v uv &> /dev/null; then
        if eval "uv run $cmd" &>/dev/null; then
            echo -e "${GREEN}✓${NC} $description"
            ((PASSED++))
        else
            echo -e "${RED}✗${NC} $description"
            ((FAILED++))
        fi
    else
        echo -e "${YELLOW}⊘${NC} $description (skipped: uv not available)"
    fi
}

# Check if we're in a Python project
if [ ! -f "$PROJECT_DIR/pyproject.toml" ]; then
    echo -e "${RED}Error: pyproject.toml not found${NC}"
    exit 1
fi

echo "Checking Python project standards..."
echo ""

# Structural checks
echo "Structural Invariants:"
check_file "pyproject.toml" "pyproject.toml exists"
check_file "README.md" "README.md exists"
check_file ".gitignore" ".gitignore exists"
check_file ".pre-commit-config.yaml" ".pre-commit-config.yaml exists"
check_file "CLAUDE.md" "CLAUDE.md exists (development instructions)"
check_dir "src" "src/ directory exists"
check_dir "tests" "tests/ directory exists"
check_file "tests/conftest.py" "tests/conftest.py exists"
echo ""

# Tool configuration checks
echo "Tool Configurations:"
if grep -q "\[tool.ruff\]" "$PROJECT_DIR/pyproject.toml"; then
    echo -e "${GREEN}✓${NC} Ruff configured in pyproject.toml"
    ((PASSED++))
else
    echo -e "${RED}✗${NC} Ruff not configured"
    ((FAILED++))
fi

if grep -q "\[tool.mypy\]" "$PROJECT_DIR/pyproject.toml"; then
    echo -e "${GREEN}✓${NC} Mypy configured in pyproject.toml"
    ((PASSED++))
else
    echo -e "${RED}✗${NC} Mypy not configured"
    ((FAILED++))
fi

if grep -q "\[tool.pytest" "$PROJECT_DIR/pyproject.toml"; then
    echo -e "${GREEN}✓${NC} Pytest configured in pyproject.toml"
    ((PASSED++))
else
    echo -e "${RED}✗${NC} Pytest not configured"
    ((FAILED++))
fi
echo ""

# Runtime quality checks
echo "Quality Checks:"
if [ -f "$PROJECT_DIR/pyproject.toml" ]; then
    # Check if dev dependencies are installed
    if command -v uv &> /dev/null; then
        echo "Running quality tools..."

        # Type checking
        if cd "$PROJECT_DIR" && uv run mypy src/ tests/ &>/dev/null; then
            echo -e "${GREEN}✓${NC} Type checking (mypy) passes"
            ((PASSED++))
        else
            echo -e "${YELLOW}⊘${NC} Type checking (mypy) has issues"
            ((FAILED++))
        fi

        # Linting
        if cd "$PROJECT_DIR" && uv run ruff check . &>/dev/null; then
            echo -e "${GREEN}✓${NC} Linting (ruff) passes"
            ((PASSED++))
        else
            echo -e "${YELLOW}⊘${NC} Linting (ruff) has issues"
            ((FAILED++))
        fi

        # Tests
        if cd "$PROJECT_DIR" && uv run pytest tests/ -q &>/dev/null; then
            echo -e "${GREEN}✓${NC} Tests (pytest) pass"
            ((PASSED++))
        else
            echo -e "${YELLOW}⊘${NC} Tests (pytest) have failures"
            ((FAILED++))
        fi
    else
        echo -e "${YELLOW}⊘${NC} Skipping runtime checks (uv not available)"
    fi
else
    echo -e "${RED}✗${NC} Cannot run quality checks (pyproject.toml missing)"
    ((FAILED++))
fi
echo ""

# Summary
echo "─────────────────────────────"
echo -e "Passed: ${GREEN}${PASSED}${NC}"
echo -e "Failed: ${RED}${FAILED}${NC}"

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ All checks passed${NC}"
    exit 0
else
    echo -e "${RED}✗ Some checks failed${NC}"
    exit 1
fi
